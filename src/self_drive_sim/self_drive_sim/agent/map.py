import os
import numpy as np
from scipy.ndimage import distance_transform_edt, zoom

from self_drive_sim.simulation.floor_map import FloorMap

OCCUPANCY_GRID_MAP0 = """
1111111111111111111111111111111111111111
1111111111111111111111111111111111111111
1100000000000000000000001000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000001000000000000011
1111111111111111111111111000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1100000000000000000000000000000000000011
1111111111111111111111111111111111111111
1111111111111111111111111111111111111111
"""

OCCUPANCY_GRID_MAP1 = """
11111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111
11111100001000000000001111111000000000000000000011
11111100001000000000001111111000000000000000000011
11111100001000000000001111111000000000000000000011
11111100001000000000000001000000000000000000000011
11111100001000000000000001000000000000000000000011
11111100001000000000000001000000000000000000000011
11110000001000000000000001000000000000000000000011
11110000000000000000000001000000000000000000011111
11110000000000000000000001000000000000000000011111
11110000000000000000000001000000000000000000011111
11110000000000000000000001000000000000000000011111
11110000001111111111111111000000000000000000011111
11110000000000000000000001000000000000000000011111
11110000000000000000000000000000000000000000011111
11110000000000000000000000000000000000000000011111
11110000000000000000000000000000000000000000011111
11110000000000000000000000000000000000000000011111
11111000000000000000000001111111111111111111111111
11000000000000000000000000000000000001111111111111
11000000000000000000000000000000000001111111111111
11000000000000000000000000000000000001111111111111
11000000000000000000000000000000000000000000000011
11000000000000000000000001000000000000000000000011
11000000000000000000000001000000000000000000000011
11000000000000000000000001000000000000000000000011
11000000000000000000000001000000000000000000000011
11000000000000000000000001000000000000000000000011
11000000000000000000000001000000000000000000000011
11000000000000000000000001000000000000000000000011
11000000000000000000000001000000000000000000000011
11000000000000000000000001111000000000000000000011
11000000000000000000000001111000000000000000000011
11000000000000000000000001111000000000000000000011
11000000000000000000000001111000000000000000000011
11000000000000000000000001111000000000000000000011
11000000000000000000000001111000000000000000000011
11000000000000000000000001111000000000000000000011
11000000000000000000000001111000000000000000000011
11000000000000000000000001111000000000000000000011
11111111111111110000000011111111111111111111111111
11000000000000000000000000000000000000000000011111
11000000000000000000000000000000000000000000011111
11000000000000000000000000000000000000000000011111
11000000000000000000000000000000000000000000011111
11110000000000000000000000000000000000000000011111
11110000000000000000000000000000000000000000011111
11111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111
"""

OCCUPANCY_GRID_MAP2 = """
111111111111111111111111111111111111111111111111111111111000000000000000000
111111111111111111111111111111111111111111111111111111111000000000000000000
110000000000000000000000111110000001000000000000000000011000000000000000000
110000000000000000000000111110000001000000000000000000011000000000000000000
110000000000000000000000111110000001000000000000000000011000000000000000000
110000000000000000000000111110000001000000000000000000011000000000000000000
110000000000000000000000111110000000000000000000000000011000000000000000000
110000000000000000000000111110000000000000000000000000011000000000000000000
110000000000000000000000111110000000000000000000000000011000000000000000000
110000000000000000000000111110000000000000000000000000011000000000000000000
110000000000000000000000000010000001000000000000000000011000000000000000000
110000000000000000000000000000000001000000000000000000011000000000000000000
110000000000000000000000000000000001000000000000000000011111111111111111111
110000000000000000000000000000000001000000000000000000011111111111111111111
110000000000000000000000000000000001111111111111111111111111111111111111111
110000000000000000000000000010000000000000000000011111111111111111111111111
111111111111111111111111111110000000000000000000011111111111111111111111111
111111111111000000000000000010000000000000000000011111111111111111111111111
111111111111000000000000000000000000000000000000011111111111111111111111111
111111111111000000000000000000000000000000000000000000000000000000000011111
111111111111000000000000000000000000000000000000000000000000000000000011111
111111111111000000000000000000000000000000000000000000000000000000000011111
111111111111000000000000000010000000000000000000000000000000000000000011111
111000000001000000000000000010000000000000000000000000000000000000000011111
111000000001000000000000000010000000000000000000000000000000000000000011111
111000000001000000000000000010000000000000000000000000000000000000000011111
111000000001000000000000000010000000000000000000000000000000000000000011111
111000000001000000000000000010000000000000000000000000000000000000000011111
111000000001000000000000000010000000000000000000000000000000000000000011111
111000000001000000000000000010000000000000000000000000000000000000000011111
111000000001000000000000000010000000000000000000011111111111111111111111111
111000000001000000000000000010000000000000000000011111111111111111111111111
111000000001000000000000000010000000000000000000011111111111111111111111111
111000000001000000000000000010000000000000000000011111111111111111111111111
111110000111111111111111111110000000000000000000000000000000000000000001111
111100000000000000000000000010000000000000000000000000000000000000000001111
111100000000000000000000000000000000000000000000000000000000000000000001111
111100000000000000000000000000000000000000000000000000000000000000000001111
111100000000000000000000000000000000000000000000000000000000000000000001111
111100000000000000000000000000000000000000000000000000000000000000000001111
111100000000000000000000000010000000000000000000000000000000000000000001111
111100000000000000000000000010000000000000000000000000000000000000000001111
111100000000000000000000000010000000000000000000000000000000000000000001111
111100000000000000000000000010000000000000000000000000000000000000000001111
111100000000000000000000000010000000000000000000000000000000000000000000011
111100000000000000000000000010000000000000000000000000000000000000000000011
111100000000000000000000000010000000000000000000000000000000000000000000011
111100000000000000000000000010000000000000000000000000000000000000000000011
111100000000000000000000000010000000000000000000000000000000000000000000011
111100000000000000000000000010000000000000000000000000000000000000000000011
111111111111111111111111111110000000000000000000000000000000000000000000011
111111111111111111111111111110000000000000000000000000000000000000000000011
000000000000000000000000000110000000000000000000000000000000000000000000011
000000000000000000000000000110000000000000000000000000000000000000000000011
000000000000000000000000000110000000000000000000000000000000000000000000011
000000000000000000000000000110000000000000000000000000000000000000000000011
000000000000000000000000000110000000000000000000000000000000000000000000011
000000000000000000000000000110000000000000000000000000000000000000000000011
000000000000000000000000000110000000000000000000000000000000000000000000011
000000000000000000000000000110000000000000000000000000000000000000000000011
000000000000000000000000000110000000000000000000000000000000000000000000011
000000000000000000000000000110000000000000000000000000000000000000000000011
000000000000000000000000000110000000000000000000000000000000000000000000011
000000000000000000000000000110000000000000000000000000000000000000000000011
000000000000000000000000000110000000000000000000000000000000000000000000011
000000000000000000000000000111111100000000111111111111110000000011111111111
000000000000000000000000000111100000000000000000000000000000000000000001111
000000000000000000000000000111100000000000000000000000000000000000000001111
000000000000000000000000000110000000000000000000000000000000000000000000011
000000000000000000000000000110000000000000000000000000000000000000000000011
000000000000000000000000000110000000000000000000000000000000000000000000011
000000000000000000000000000111100000000000000000000000000000000000000001111
000000000000000000000000000111100000000000000000000000000000000000000001111
000000000000000000000000000111111111111111111111111111111111111111111111111
000000000000000000000000000111111111111111111111111111111111111111111111111
"""

OCCUPANCY_GRID_MAP3 = """
1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
1100000000000000000000000000000000111111111111111100000000111100000000000000001111111100000000000011
1100000000000000000000000000000000000000000000000000000000111100000000000000001111111100000000000011
1100000000000000000000000000000000000000000000000000000000111100000000000000001111111100000000000011
1100000000000000000000000000000000000000000000000000000000111100000000000000001111111100000000000011
1100000001000000000100000000000000000000000000000000000000111100000000000000001111111100000000000011
1100000001000000000100000000000000000000000000000000000000111100000000000000001111111100000000000011
1100000001111111111111111111111111111111111111111100000000111100000000000000001111111100000000000011
1100000001111111111111111111111111111111111111111100000000111100000000000000001111111100000000000011
1100000001111111111111111111111111111111111111111100000000111111111111110000111111111100000000000011
1100000000000100000000000000000011111111111111111000000000000000000000000000000000000100000000000011
1100000000000000000000000000000011111111111111111000000000000000000000000000000000000100000000000011
1100000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000011
1100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011
1100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011
1100000000000100000000111110000000000000000000000000000000000000000000000000000000000000000000000011
1111111111111100000000111110000000000000000000000000000000111111111111111111100000000000000000000011
1100000000000100000000111110000000000000000000000000000000100000000000000000100000000100000000000011
1100000000000100000000111110000000000000000000000000000000100000000000000000100000000100000000000011
1100000000000100000000111110000000000000000000000000000000000000000000000000000000000100000000000011
1100000000000100000000111110000000000000000000000000000000000000000000000000000000000100000000000011
1100000000000100000000111110000000000000000000000000000000000000000000000000000000000100000000000011
1100000000000100000000111110000000000000000000000000000000000000000000000000000000000100000000000011
1100000000000100000000111110000000000000000000000000000000100000000000000000100000000100000000000011
1100000000000100000000111110000000000000000000000000000000100000000000000000100000000100000000000011
1100000000000100000000111110000000000000000000000000000000100000000000000000100000000100000000000011
1100000000000100000000111110000000000000000000111100000011111111111111111111100000000111111111111111
1100000000000100000000111111111111111111111111111100000010000000000000000000100000000100000000000011
1100000000000100000000111111111111111111111111111100000010000000000000000000000000000000000000000011
1100000000000100000000111111111111111111111111111100000010000000000000000000000000000000000000000011
1100000000000100000000111111111111111111111111111100000010000000000000000000000000000000000000000011
1100000000000100000000100000000000000000000000000100000010000000000000000000000000000000000000000011
1100000000000000000000000000000000000000000000000100000010000000000000000000100000000100000000000011
1100000000000000000000000000000000000000000000000100000010000000000000000000100000000100000000000011
1100000000000000000000000000000000000000000000000100000010000000000000000000100000000100000000000011
1100000000000000000000000000000000000000000000000100000010000000000000000000100000000100000000000011
1100000000000100000000100000000000000000000000000100000010000000000000000000100000000100000000000011
1100000000000100000000100000000000000000000000000100000010000000000000000000100000000100000000000011
1100000000000100000000100000000000000000000000000100000010000000000000000000100000000100000000000011
1100000000000100000000100000000000000000000000000100000010000000000000000000100000000100000000000011
1100000000000100000000100000000000000000000000000100000010000000000000000000100000000100000000000011
1111111111111100000000100000000000000000000000000100000010000000000000000000100000000100000000000011
1100000000000100000000100000000000000000000000000100000010000000000000000000100000000100000000000011
1100000000000100000000100000000000000000000000000100000010000000000000000000100000000100000000000011
1100000000000100000000100000000000000000000000000100000010000000000000000000100000000100000000000011
1100000000000100000000100000000000000000000000000100000010000000000000000000100000000100000000000011
1100000000000100000000111111111111111111111100001100000011000011111111111111100000000100000000000011
1100000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000011
1100000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000011
1100000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000011
1100000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000011
1100000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000011
1100000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000011
1100000000000100000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000100000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000100000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000100000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000100000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1111111111111100000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000100000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000100000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000100000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000100000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000100000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000100000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000000000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000000000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000000000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000000000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000000000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000000000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000100000000100000000000000000100000000000000000100000000000000000100000000000000000000011
1100000000000100000000100000000000000000100000000000000000100000000000000000100000000000000000000011
1100000000000100000000100000000000000000100000000000000000100000000000000000100000000000000000000011
1100000000000100000000100000000000000000100000000000000000100000000000000000100000000000000000000011
1100000000000100000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1100000000000100000000100000000000000000100000000000000000100000000000000000100000000100000000000011
1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
"""

class Map:
    def print_occupancy_grid_map(self, 
            map_path
        ) -> None:
        if not os.path.exists(map_path):
            raise FileNotFoundError(f"Map file not found: {map_path}")
        wall_grid = FloorMap.from_file(map_path).to_map_info(0, None, 0.0).wall_grid
        for row in wall_grid.astype(int):
            print(''.join(map(str, row)))

    def string_to_np_array_map(self, 
            string_map: str
        ) -> np.ndarray:
        return np.array([list(map(int, line)) 
                        for line in string_map.strip().splitlines() 
                        if line.strip()], dtype=np.int8)
        
    def np_array_to_string_map(self, 
            array_map: np.ndarray
        ) -> str:
        lines = ["".join(map(str, row)) for row in array_map]
        return "\n".join(lines)

    def occupancy_grid_to_distance_map(self, 
            occupancy_grid_map: np.ndarray, map_resolution: float
        ) -> np.ndarray:
        dist_map = distance_transform_edt(occupancy_grid_map == 0)
        dist_map = dist_map * map_resolution
        dist_map = np.round(dist_map, 2) 
        return dist_map

    def upscale_occupancy_grid_map(self, 
            occupancy_grid_map: np.ndarray, 
            scale: int
        ) -> np.ndarray:
        if scale == 1:
            return occupancy_grid_map.copy()
        
        upscaled_map = zoom(occupancy_grid_map, zoom=scale, order=0) 
        return upscaled_map

if __name__ == "__main__":
    """
    cd ~/ros_ws
    source install/setup.bash
    cd src/self_drive_sim/self_drive_sim/agent/
    python3 agent.py
    """

    # Generate occupancy grid map
    map_ = Map()
    map_.print_occupancy_grid_map('./../../worlds/map0.npz')